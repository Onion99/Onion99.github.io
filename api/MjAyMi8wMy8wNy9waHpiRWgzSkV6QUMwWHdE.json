{"title":"Androidé»‘ç§‘æŠ€ - çƒ­ä¿®å¤","date":"2022-03-07T22:38:05.000Z","date_formatted":{"ll":"2022å¹´3æœˆ7æ—¥","L":"2022/03/07","MM-DD":"03-07"},"thumbnail":"https://s1.ax1x.com/2022/03/07/b6wtK0.md.png","link":"2022/03/07/phzbEh3JEzAC0XwD","comments":true,"tags":["é»‘ç§‘æŠ€"],"categories":["Android"],"updated":"2022-03-07T14:32:37.000Z","content":"<blockquote>\n<p>çƒ­ä¿®å¤æœ¬è´¨å°±æ˜¯å°†é”™è¯¯çš„ä»£ç æ›¿æ¢æˆæ­£ç¡®çš„ä»£ç ,ä½†è¿™é‡Œçš„æ›¿æ¢ä¸æ˜¯æ”¹å†™åŸæœ‰çš„ä»£ç ,è€Œæ˜¯æä¾›ä¸€ä»½æ–°çš„æ­£ç¡®çš„ä»£ç ,è®©åº”ç”¨è¿è¡Œæ—¶ç»•è¿‡é”™è¯¯çš„ä»£ç ,ä»è€Œæ‰§è¡Œæ­£ç¡®çš„ä»£ç </p>\n</blockquote>\n<p><img src=\"https://s1.ax1x.com/2022/03/06/bDtcIx.png\" alt=\"bDtcIx.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<span id=\"more\"></span>\n<p>åŸºç¡€çŸ¥è¯†:</p>\n<ul>\n<li><a href=\"https://fullstackaction.com/pages/ccf9c0/#%E4%B8%80%E3%80%81dex-class-%E6%B5%85%E6%9E%90\" target=\"_blank\">çƒ­ä¿®å¤ä¸æ’ä»¶åŒ–åŸºç¡€ - dexä¸class</a></li>\n<li><a href=\"https://fullstackaction.com/pages/1084c4/\" target=\"_blank\">çƒ­ä¿®å¤ä¸æ’ä»¶åŒ–åŸºç¡€ - Javaä¸Androidè™šæ‹Ÿæœº</a></li>\n<li><a href=\"https://fullstackaction.com/pages/a5eb80/\" target=\"_blank\">çƒ­ä¿®å¤ä¸æ’ä»¶åŒ–åŸºç¡€ - Javaä¸Androidçš„ç±»åŠ è½½å™¨</a></li>\n</ul>\n<h2 id=\"å®ç°æ–¹æ¡ˆ\">å®ç°æ–¹æ¡ˆ<a title=\"#å®ç°æ–¹æ¡ˆ\" href=\"#å®ç°æ–¹æ¡ˆ\"></a></h2>\n<h3 id=\"nativeå±‚æ›¿æ¢æ–¹æ¡ˆ\">Nativeå±‚æ›¿æ¢æ–¹æ¡ˆ<a title=\"#nativeå±‚æ›¿æ¢æ–¹æ¡ˆ\" href=\"#nativeå±‚æ›¿æ¢æ–¹æ¡ˆ\"></a></h3>\n<blockquote>\n<p>åº•å±‚æ›¿æ¢ï¼Œä¿®æ”¹javaæ–¹æ³•åœ¨nativeå±‚çš„å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¿®å¤åçš„æ–¹æ³•ä»¥è¾¾åˆ°ä¿®å¤ç›®çš„</p>\n</blockquote>\n<p>Android/Javaä»£ç çš„æœ€å°ç»„ç»‡æ–¹å¼æ˜¯æ–¹æ³•ï¼ˆMethodï¼Œå®é™…ä¸Šï¼Œæ¯ä¸€ä¸ªdexæ–‡ä»¶æœ€å¤šå¯ä»¥åŒ…å«65536ï¼ˆ0xffffï¼‰ä¸ªæ–¹æ³•ï¼‰ï¼Œæ¯ä¸ªæ–¹æ³•åœ¨ARTè™šæ‹Ÿæœºä¸­éƒ½æœ‰ä¸€ä¸ªArtMethodç»“æ„ä½“æŒ‡é’ˆä¸ä¹‹å¯¹åº”ï¼ŒArtMethodç»“æ„ä½“ä¸­åŒ…å«äº†Javaæ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰§è¡Œå…¥å£ã€è®¿é—®æƒé™ã€æ‰€å±ç±»å’Œä»£ç æ‰§è¡Œåœ°å€ç­‰ç­‰ã€‚æ¢å¥è¯è¯´ï¼Œè™šæ‹Ÿæœºå°±æ˜¯é€šè¿‡ArtMethodç»“æ„ä½“æ¥æ“çºµJavaæ–¹æ³•çš„ã€‚ArtMethodç»“æ„å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArtMethod</span> <span class=\"title\">FINAL</span> &#123;</span></span><br><span class=\"line\">...</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">  GcRoot&lt;mirror::Class&gt; declaring_class_;</span><br><span class=\"line\"></span><br><span class=\"line\">  std::atomic&lt;std::<span class=\"keyword\">uint32_t</span>&gt; access_flags_;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Offset to the CodeItem.</span></span><br><span class=\"line\">  <span class=\"keyword\">uint32_t</span> dex_code_item_offset_;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Index into method_ids of the dex file associated with this method.</span></span><br><span class=\"line\">  <span class=\"keyword\">uint32_t</span> dex_method_index_;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">uint16_t</span> method_index_;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">uint16_t</span> hotness_count_;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">PtrSizedFields</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// Depending on the method type, the data is</span></span><br><span class=\"line\">    <span class=\"comment\">//   - native method: pointer to the JNI function registered to this method</span></span><br><span class=\"line\">    <span class=\"comment\">//                    or a function to resolve the JNI function,</span></span><br><span class=\"line\">    <span class=\"comment\">//   - conflict method: ImtConflictTable,</span></span><br><span class=\"line\">    <span class=\"comment\">//   - abstract/interface method: the single-implementation if any,</span></span><br><span class=\"line\">    <span class=\"comment\">//   - proxy method: the original interface method or constructor,</span></span><br><span class=\"line\">    <span class=\"comment\">//   - other methods: the profiling data.</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span>* data_;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Method dispatch from quick compiled code invokes this pointer which may cause bridging into</span></span><br><span class=\"line\">    <span class=\"comment\">// the interpreter.</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span>* entry_point_from_quick_compiled_code_;</span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  ptr_sized_fields_;</span><br><span class=\"line\">...</span><br><span class=\"line\">ï½</span><br></pre></td></tr></table></figure>\n<p>å…¶ä¸­æœ‰ä¸€ä¸ªå…³é”®æŒ‡é’ˆï¼Œå®ƒæ˜¯æ–¹æ³•çš„æ‰§è¡Œå…¥å£ï¼š<br>\n<code>entry_point_from_quick_compiled_code_</code><br>\nä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ–¹æ³•ä½“ç¼–è¯‘åå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬èƒ½hookè¿™ä¸ªæŒ‡é’ˆï¼Œç”±åŸæ¥æŒ‡å‘æœ‰bugçš„æ–¹æ³•ï¼Œå˜æˆæŒ‡å‘æ­£ç¡®çš„æ–¹æ³•ï¼Œå°±è¾¾åˆ°äº†ä¿®å¤çš„ç›®çš„ã€‚è¿™å°±æ˜¯nativeå±‚æ›¿æ¢æ–¹æ¡ˆçš„æ ¸å¿ƒåŸç†ã€‚å…·ä½“å®ç°æ–¹æ¡ˆå¯ä»¥æ˜¯æ”¹å˜æŒ‡é’ˆæŒ‡å‘ï¼ˆAndFixï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ›¿æ¢æ•´ä¸ªç»“æ„ä½“ï¼ˆSophixï¼‰ã€‚</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚æ›¿æ¢æ–¹æ¡ˆè™½ç„¶æ˜¯å³ä½¿ç”Ÿæ•ˆçš„ï¼Œä½†æ˜¯å› ä¸ºä¸ä¼šåŠ è½½æ–°ç±»ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹åŸç±»ï¼Œæ‰€ä»¥ä¿®æ”¹çš„ä»£ç ä¸èƒ½å¢åŠ æ–°çš„æ–¹æ³•ï¼Œå¦åˆ™ä¼šé€ æˆç´¢å¼•æ•°ä¸æ–¹æ³•æ•°ä¸åŒ¹é…ï¼Œæ— æ³•é€šè¿‡ç´¢å¼•æ‰¾åˆ°æ­£ç¡®æ–¹æ³•ï¼Œå­—æ®µåŒç†</p>\n<h3 id=\"ç±»åŠ è½½æ–¹æ¡ˆ\">ç±»åŠ è½½æ–¹æ¡ˆ<a title=\"#ç±»åŠ è½½æ–¹æ¡ˆ\" href=\"#ç±»åŠ è½½æ–¹æ¡ˆ\"></a></h3>\n<blockquote>\n<p>åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œéƒ½ä¼šå»å¾ªç¯dexElementsæ•°ç»„å–å‡ºé‡Œé¢çš„dexæ–‡ä»¶ï¼Œç„¶åä»dexæ–‡ä»¶ä¸­æ‰¾ç›®æ ‡ç±»ï¼Œåªè¦ç›®æ ‡ç±»æ‰¾åˆ°ï¼Œåˆ™ç›´æ¥é€€å‡ºå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯åé¢çš„dexæ–‡ä»¶å°±æ²¡æœ‰è¢«å–åˆ°çš„æœºä¼šã€‚å°†çƒ­ä¿®å¤çš„ç±»æ”¾åœ¨dexElements[]çš„æœ€å‰é¢ï¼Œè¿™æ ·åŠ è½½ç±»æ—¶ <strong>ä¼šä¼˜å…ˆåŠ è½½åˆ°è¦ä¿®å¤çš„ç±»</strong>ä»¥è¾¾åˆ°ä¿®å¤ç›®çš„</p>\n</blockquote>\n<p><img src=\"https://s1.ax1x.com/2022/03/06/bDduwj.png\" alt=\"bDduwj.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<p>åŸºäºjvmçš„javaåº”ç”¨æ˜¯é€šè¿‡ClassLoaderæ¥åŠ è½½åº”ç”¨ä¸­çš„classçš„ï¼ŒAndroidå¯¹JVMä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨çš„æ˜¯ART(ä»¥å‰æ˜¯Dalvik)ï¼Œclassæ–‡ä»¶ä¼šè¢«æ‰“åŒ…è¿›dexæ–‡ä»¶ä¸­ï¼Œåº•å±‚è™šæ‹Ÿæœºæœ‰æ‰€ä¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬çš„ç±»åŠ è½½å™¨ä¹Ÿä¼šæœ‰æ‰€åŒºåˆ«ï¼Œåœ¨Androidä¸­ï¼Œè¦åŠ è½½dexæ–‡ä»¶ä¸­çš„classæ–‡ä»¶å°±éœ€è¦ç”¨åˆ° PathClassLoader æˆ– DexClassLoader è¿™ä¸¤ä¸ªAndroidä¸“ç”¨çš„ç±»åŠ è½½å™¨ã€‚</p>\n<p><img src=\"https://s1.ax1x.com/2022/03/07/bsEKiR.png\" alt=\"bsEKiR.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<h4 id=\"åŸç†\">åŸç†<a title=\"#åŸç†\" href=\"#åŸç†\"></a></h4>\n<p><img src=\"https://s1.ax1x.com/2022/03/07/bsdsXT.png\" alt=\"bsdsXT.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<h4 id=\"ç”Ÿæˆä¿®å¤dex\">ç”Ÿæˆä¿®å¤Dex<a title=\"#ç”Ÿæˆä¿®å¤dex\" href=\"#ç”Ÿæˆä¿®å¤dex\"></a></h4>\n<p>1.å°†å‡ºbugçš„ç±»ä¿®æ”¹æ­£ç¡®ï¼Œç„¶åæ‰§è¡Œæ‰“åŒ…æµç¨‹  <a href=\"https://imgtu.com/i/bsNkSf\" target=\"_blank\"><img src=\"https://s1.ax1x.com/2022/03/07/bsNkSf.png\" alt=\"bsNkSf.png\" loading=\"lazy\"></a></p>\n<p>2.æ­¤æ—¶å–å‡ºå·¥ç¨‹ç›®å½•ä¸‹çš„/build/intermediates/javac/debug/classes/åŒ…è·¯å¾„/æ–‡ä»¶å¤¹ä¸‹å¯¹åº”çš„classæ–‡ä»¶</p>\n<p>3.åœ¨å¤åˆ¶è¿™ä¸ªclassæ–‡ä»¶æ—¶ï¼Œéœ€è¦æŠŠå®ƒæ‰€åœ¨çš„å®Œæ•´åŒ…ç›®å½•ä¸€èµ·å¤åˆ¶ï¼Œç„¶ååœ¨å‘½ä»¤è¡Œä¸‹cdåˆ°è¯¥ç›®å½•ï¼Œæ‰§è¡Œ<code>dx --dex --output=patch.dex åŒ…åè·¯å¾„/éœ€è¦ä¿®å¤çš„ç±»æ–‡ä»¶</code>,æ­¤æ—¶ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆpatch.dexæ–‡ä»¶  <a href=\"https://imgtu.com/i/bsNQf0\" target=\"_blank\"><img src=\"https://s1.ax1x.com/2022/03/07/bsNQf0.png\" alt=\"bsNQf0.png\" loading=\"lazy\"></a></p>\n<p>4.ç„¶åå°†patch.dexæ–‡ä»¶å½“æˆè¡¥ä¸åŒ…æ”¾å…¥èµ„æºæ–‡ä»¶å¤¹rawä¸‹å³å¯ã€‚</p>\n<p>æŒ‡ä»¤ä¸ºï¼šdx --dex --output=patch.dex com/xxx/xxx/fixbug.class -&gt; ç”Ÿæˆpatch.dexæ–‡ä»¶</p>\n<p>ä¹Ÿå¯ä»¥å†™æˆï¼šdx --dex --output=patch.jar com/xxx/xxx/fixbug.class -&gt; ç”Ÿæˆpatch.jaræ–‡ä»¶</p>\n<p>ClassLoaderå¯ä»¥åŠ è½½.dexæ–‡ä»¶ï¼Œæˆ–è€….zipã€.jarã€.apkä¸­åŒ…å«çš„.dexæ–‡ä»¶</p>\n<h4 id=\"å®è·µ\">å®è·µ<a title=\"#å®è·µ\" href=\"#å®è·µ\"></a></h4>\n<p>Application:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * ä¹‹æ‰€ä»¥è¦åœ¨æœ¬ç±»ä¸­åšè¡¥ä¸åŒ…çš„å®‰è£…æ˜¯å› ä¸ºæ€•å¦‚æœåœ¨åé¢çš„æµç¨‹ä¸­åšå®‰è£…ä¼šé€ æˆæœ‰äº›å¸¦bugçš„ç±»å¦‚æœå·²ç»è¢«ç³»ç»ŸåŠ è½½çš„è¯ï¼Œåç»­è¡¥ä¸åŒ…å®‰è£…ä¹‹å</span></span><br><span class=\"line\"><span class=\"comment\"> * è¡¥ä¸åŒ…ä¸­çš„ç±»å¾—ä¸åˆ°æ‰§è¡Œï¼Œå› ä¸ºç±»åŠ è½½æœ‰ç¼“å­˜æœºåˆ¶ï¼Œç³»ç»Ÿä¼šå°†åŠ è½½è¿‡çš„ç±»åšä¸€ä»½å†…å­˜ç¼“å­˜ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyApplication</span> <span class=\"keyword\">extends</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.onCreate();</span><br><span class=\"line\">        <span class=\"comment\">// æ­¤å¤„ä¸ºåŠ è½½è¡¥ä¸åŒ…ï¼Œå…¶å®çœŸå®åº”ç”¨åœºæ™¯æ˜¯ä»æœåŠ¡ç«¯ä¸‹è½½è¡¥ä¸æ–‡ä»¶ï¼Œå› ä¸ºæœ¬å·¥ç¨‹ä¸ºç¤ºä¾‹æ‰€ä»¥ç›´æ¥å°†å…¶æ”¾åœ¨rawèµ„æºæ–‡ä»¶ç›®å½•ä¸‹å»è¯»å–ï¼Œçœå»äº†ä¸‹è½½è¿‡ç¨‹</span></span><br><span class=\"line\">        File patchFile = <span class=\"keyword\">new</span> File(getCacheDir().getAbsolutePath() + File.separator + <span class=\"string\">&quot;patch.dex&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ä¸ºäº†é«˜ç‰ˆæœ¬Androidè®¿é—®å¤–éƒ¨å­˜å‚¨éœ€è¦åˆ†åŒºç­‰é—®é¢˜ï¼Œå› ä¸ºæ­¤å¤„ä»…åšç¤ºä¾‹è®²è§£æ‰€ä»¥å°±ç›´æ¥å°†åŒ…æ‹·è´åˆ°ç§æœ‰ç›®å½•ä¸­</span></span><br><span class=\"line\">            <span class=\"comment\">// æ‹·è´åˆ°ç§æœ‰ç›®å½•ä¸­è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯é¿å…åœ¨è¡¥ä¸åŒ…å®‰è£…è¿‡ç¨‹ä¸­åŒ…æ–‡ä»¶è¢«åˆ é™¤é€ æˆå®‰è£…å¤±è´¥</span></span><br><span class=\"line\">            copyFile(patchFile);</span><br><span class=\"line\">            <span class=\"comment\">// å®‰è£…è¡¥ä¸åŒ…</span></span><br><span class=\"line\">            HotFix.installPatch(<span class=\"keyword\">this</span>, patchFile);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">copyFile</span><span class=\"params\">(File dest)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        InputStream input = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        OutputStream output = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ç”±äºæœ¬é¡¹ç›®æ˜¯æµ‹è¯•åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å°†è¡¥ä¸åŒ…æ”¾åœ¨å·¥ç¨‹å†…ï¼ŒçœŸå®å¼€å‘ç¯å¢ƒä¸­åº”è¯¥æ˜¯æ”¾åœ¨æœåŠ¡å™¨ç„¶åä¸‹è½½ä¸‹æ¥</span></span><br><span class=\"line\">            input = getResources().openRawResource(R.raw.patch);</span><br><span class=\"line\">            output = <span class=\"keyword\">new</span> FileOutputStream(dest);</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] buf = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">1024</span>];</span><br><span class=\"line\">            <span class=\"keyword\">int</span> bytesRead;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((bytesRead = input.read(buf)) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                output.write(buf, <span class=\"number\">0</span>, bytesRead);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            input.close();</span><br><span class=\"line\">            output.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>HotFix.installPatch:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HotFix</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">installPatch</span><span class=\"params\">(Application application, File patch)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (patch == <span class=\"keyword\">null</span> || !patch.exists()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             * 1.è·å–å½“å‰çš„ç±»åŠ è½½å™¨z</span></span><br><span class=\"line\"><span class=\"comment\">             */</span></span><br><span class=\"line\">            ClassLoader classLoader = application.getClassLoader();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             * 2.è·å–åˆ°dexElementså±æ€§ä»¥ä¾¿åç»­å‘å‰è¿½åŠ patch.dex</span></span><br><span class=\"line\"><span class=\"comment\">             */</span></span><br><span class=\"line\">            Field pathListField = ReflectUtils.findField(classLoader, <span class=\"string\">&quot;pathList&quot;</span>);</span><br><span class=\"line\">            Object pathList = pathListField.get(classLoader);</span><br><span class=\"line\">            Field dexElementsField = ReflectUtils.findField(pathList, <span class=\"string\">&quot;dexElements&quot;</span>);</span><br><span class=\"line\">            Object[] dexElements = (Object[]) dexElementsField.get(pathList);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             * 3.é€šè¿‡åå°„è°ƒç”¨DexPathListç±»ä¸­çš„makePathElements()æ–¹æ³•å°†patch.dexæœ€ç»ˆè½¬æ¢ä¸ºElement[]æ•°ç»„ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">             * DexPathListä¸€ç³»åˆ—æ–¹æ³•éƒ½æ˜¯ç”¨æ¥å°†è¡¥ä¸åŒ…è½¬æ¢ä¸ºElement[]æ•°ç»„çš„ï¼Œå¦‚makePathElementsï¼ŒmakeDexElements..</span></span><br><span class=\"line\"><span class=\"comment\">             * å…·ä½“çš„APIæ ¹æ®çœŸå®APIçš„ç‰ˆæœ¬ä¸åŒæ–¹æ³•å‚æ•°ç­‰å¯èƒ½ä¼šæœ‰å‡ºå…¥ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å®é™…ä¸Šåº”è¯¥é€šè¿‡åˆ¤æ–­å»å…¼å®¹å„ä¸ªç‰ˆæœ¬ï¼Œ</span></span><br><span class=\"line\"><span class=\"comment\">             * æ­¤å¤„å› ä¸ºæ˜¯ç¤ºä¾‹æ‰€ä»¥æ²¡åšå…¼å®¹</span></span><br><span class=\"line\"><span class=\"comment\">             */</span></span><br><span class=\"line\">            List&lt;File&gt; files = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">            files.add(patch);</span><br><span class=\"line\">            Method method = ReflectUtils.findMethod(pathList, <span class=\"string\">&quot;makePathElements&quot;</span>, List.class, File.class, List.class);</span><br><span class=\"line\">            ArrayList&lt;IOException&gt; suppressedExceptions = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">            Object[] patchElements = (Object[]) method.invoke(pathList, files, application.getCacheDir(), suppressedExceptions);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             * 4.åˆå¹¶patchElements+dexElements,å°†è¡¥ä¸åŒ…çš„.dexæ–‡ä»¶æ’å…¥æ•°ç»„æœ€å‰é¢ï¼Œåç»­åœ¨åŠ è½½ç±»çš„æ—¶å€™ä¼šä¼˜å…ˆä»ç¬¬ä¸€ä¸ªå¼€å§‹éå†æŸ¥æ‰¾ç±»</span></span><br><span class=\"line\"><span class=\"comment\">             */</span></span><br><span class=\"line\">            Object[] newElements = (Object[]) Array.newInstance(dexElements.getClass().getComponentType(), dexElements.length + patchElements.length);</span><br><span class=\"line\">            System.arraycopy(patchElements, <span class=\"number\">0</span>, newElements, <span class=\"number\">0</span>, patchElements.length);</span><br><span class=\"line\">            System.arraycopy(dexElements, <span class=\"number\">0</span>, newElements, patchElements.length, dexElements.length);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">             * 5.å°†æ–°æ•°ç»„ç½®æ¢æ‰BaseDexClassLoader -&gt; pathList -&gt; dexElementså±æ€§ï¼Œè‡³æ­¤å·¥ä½œå®Œæˆ</span></span><br><span class=\"line\"><span class=\"comment\">             */</span></span><br><span class=\"line\">            dexElementsField.set(pathList, newElements);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReflectUtils</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* æ‰¾åˆ°åå°„å±æ€§ **/</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Field <span class=\"title\">findField</span><span class=\"params\">(Object instance, String name)</span> </span>&#123;</span><br><span class=\"line\">        Class&lt;?&gt; clz = instance.getClass();</span><br><span class=\"line\">        Field field = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (clz != Object.class) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                field = clz.getDeclaredField(name);</span><br><span class=\"line\">                field.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> field;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (NoSuchFieldException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//å‘çˆ¶ç±»å¯»æ‰¾å±æ€§</span></span><br><span class=\"line\">            clz = clz.getSuperclass();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> field;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/* æ‰¾åˆ°åå°„å‡½æ•° **/</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Method <span class=\"title\">findMethod</span><span class=\"params\">(Object instance, String name, Class&lt;?&gt;... parameterTypes)</span> </span>&#123;</span><br><span class=\"line\">        Class&lt;?&gt; clz = instance.getClass();</span><br><span class=\"line\">        Method method = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (clz != Object.class) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                method = clz.getDeclaredMethod(name, parameterTypes);</span><br><span class=\"line\">                method.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> method;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//å‘çˆ¶ç±»å¯»æ‰¾å±æ€§</span></span><br><span class=\"line\">            clz = clz.getSuperclass();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> method;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">/* æ‰¾åˆ°åå°„æ‰€æœ‰å‡½æ•°æ•°ç»„ **/</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Method[] findAllMethods(Object instance) &#123;</span><br><span class=\"line\">        Class&lt;?&gt; clz = instance.getClass();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> clz.getDeclaredMethods();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å®é™…ä¸Šï¼Œç±»æ›¿æ¢æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šå°†ä¿®æ”¹åçš„patchï¼ˆåŒ…å«bugç±»æ–‡ä»¶ï¼‰æ‰“åŒ…æˆdexæ–‡ä»¶ï¼Œç„¶åhook ClassLoaderåŠ è½½æµç¨‹ï¼Œå°†è¿™ä¸ªdexæ–‡ä»¶æ’å…¥åˆ°Elementæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚å› ä¸ºåŠ è½½ç±»æ˜¯ä¾æ¬¡è¿›è¡Œçš„ï¼Œæ‰€ä»¥è™šæ‹Ÿæœºä»ç¬¬ä¸€ä¸ªElementæ‰¾åˆ°ç±»åï¼Œå°±ä¸ä¼šå†åŠ è½½bugç±»äº†ã€‚</p>\n<p>ç±»åŠ è½½æ–¹æ¡ˆä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå› ä¸ºç±»åŠ è½½åæ— æ³•å¸è½½ï¼Œæ‰€ä»¥ç±»åŠ è½½æ–¹æ¡ˆå¿…é¡»é‡å¯Appï¼Œè®©bugç±»é‡æ–°åŠ è½½åæ‰èƒ½ç”Ÿæ•ˆ</p>\n<h3 id=\"instant-runæ–¹æ¡ˆ\">Instant Runæ–¹æ¡ˆ<a title=\"#instant-runæ–¹æ¡ˆ\" href=\"#instant-runæ–¹æ¡ˆ\"></a></h3>\n<blockquote>\n<p>Instant Run æ–¹æ¡ˆçš„æ ¸å¿ƒæ€æƒ³æ˜¯â€”â€”æ’æ¡©ï¼Œåœ¨ç¼–è¯‘æ—¶é€šè¿‡æ’æ¡©åœ¨æ¯ä¸€ä¸ªæ–¹æ³•ä¸­æ’å…¥ä»£ç ï¼Œä¿®æ”¹ä»£ç é€»è¾‘ï¼Œåœ¨éœ€è¦æ—¶ç»•è¿‡é”™è¯¯æ–¹æ³•ï¼Œè°ƒç”¨patchç±»çš„æ­£ç¡®æ–¹æ³•</p>\n</blockquote>\n<p>é¦–å…ˆï¼Œåœ¨ç¼–è¯‘æ—¶Instant Runä¸ºæ¯ä¸ªç±»æ’å…¥IncrementalChangeå˜é‡ï¼š<br>\n<code>IncrementalChange  $change;</code></p>\n<p>ä¸ºæ¯ä¸€ä¸ªæ–¹æ³•æ·»åŠ ç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCreate</span><span class=\"params\">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class=\"line\">        IncrementalChange var2 = $change;</span><br><span class=\"line\">        <span class=\"comment\">//$changeä¸ä¸ºnullï¼Œè¡¨ç¤ºè¯¥ç±»æœ‰ä¿®æ”¹ï¼Œéœ€è¦é‡å®šå‘</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(var2 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//é€šè¿‡access$dispatchæ–¹æ³•è·³è½¬åˆ°patchç±»çš„æ­£ç¡®æ–¹æ³•</span></span><br><span class=\"line\">            var2.access$dispatch(<span class=\"string\">&quot;onCreate.(Landroid/os/Bundle;)V&quot;</span>, <span class=\"keyword\">new</span> Object[]&#123;<span class=\"keyword\">this</span>, savedInstanceState&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>.onCreate(savedInstanceState);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.setContentView(<span class=\"number\">2130968601</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.tv = (TextView)<span class=\"keyword\">this</span>.findViewById(<span class=\"number\">2131492944</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>å¦‚ä¸Šä»£ç ï¼Œå½“ä¸€ä¸ªç±»è¢«ä¿®æ”¹åï¼ŒInstant Runä¼šä¸ºè¿™ä¸ªç±»æ–°å»ºä¸€ä¸ªç±»ï¼Œå‘½åä¸ºxxx&amp;overrideï¼Œä¸”å®ç°IncrementalChangeæ¥å£ï¼Œå¹¶ä¸”èµ‹å€¼ç»™åŸç±»çš„$changeå˜é‡ã€‚</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainActivity</span>$<span class=\"title\">override</span> <span class=\"keyword\">implements</span> <span class=\"title\">IncrementalChange</span> </span>&#123;</span><br><span class=\"line\">ï½</span><br></pre></td></tr></table></figure>\n<p>æ­¤æ—¶ï¼Œåœ¨è¿è¡Œæ—¶åŸç±»ä¸­æ¯ä¸ªæ–¹æ³•çš„var2 != nullï¼Œé€šè¿‡accessdispatchï¼ˆå‚æ•°æ˜¯æ–¹æ³•åå’ŒåŸå‚æ•°ï¼‰å®šä½åˆ°patchç±»MainActivityoverrideä¸­ä¿®æ”¹åçš„æ–¹æ³•ã€‚</p>\n<p>Instant Runæ˜¯googleåœ¨AS2.0æ—¶ç”¨æ¥å®ç°â€œçƒ­éƒ¨ç½²â€çš„ï¼ŒåŒæ—¶ä¹Ÿä¸ºâ€œçƒ­ä¿®å¤â€æä¾›äº†ä¸€ä¸ªç»ä½³çš„æ€è·¯ã€‚ç¾å›¢çš„Robustå°±æ˜¯åŸºäºæ­¤ã€‚</p>\n<h3 id=\"soåº“ä¿®å¤\">SOåº“ä¿®å¤<a title=\"#soåº“ä¿®å¤\" href=\"#soåº“ä¿®å¤\"></a></h3>\n<h4 id=\"æ¥å£è°ƒç”¨æ›¿æ¢\">æ¥å£è°ƒç”¨æ›¿æ¢<a title=\"#æ¥å£è°ƒç”¨æ›¿æ¢\" href=\"#æ¥å£è°ƒç”¨æ›¿æ¢\"></a></h4>\n<p>sdkæä¾›æ¥å£æ›¿æ¢Systemé»˜è®¤åŠ è½½soåº“çš„æ¥å£</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SOPatchManger.loadLibrary(String libName)</span><br><span class=\"line\"><span class=\"comment\">//ä»£æ›¿</span></span><br><span class=\"line\">System.loadLibrary(String libName)</span><br></pre></td></tr></table></figure>\n<p>SOPatchManger.loadLibraryæ¥å£åŠ è½½soåº“çš„æ—¶å€™ä¼˜å…ˆå°è¯•å»åŠ è½½sdkæŒ‡å®šç›®å½•ä¸‹è¡¥ä¸çš„soã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™å†å»åŠ è½½å®‰è£…apkç›®å½•ä¸‹çš„soåº“</p>\n<p>ä¼˜ç‚¹ï¼šä¸éœ€è¦å¯¹ä¸åŒsdkç‰ˆæœ¬è¿›è¡Œå…¼å®¹ï¼Œæ‰€ä»¥sdkç‰ˆæœ¬éƒ½æ˜¯System.loadLibraryè¿™ä¸ªæ¥å£<br>\nç¼ºç‚¹ï¼šéœ€è¦ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼Œæ›¿æ¢æ‰Systemé»˜è®¤åŠ è½½soåº“çš„æ¥å£</p>\n<h4 id=\"åå°„æ³¨å…¥\">åå°„æ³¨å…¥<a title=\"#åå°„æ³¨å…¥\" href=\"#åå°„æ³¨å…¥\"></a></h4>\n<p>é‡‡å–ç±»ä¼¼ç±»ä¿®å¤åå°„æ³¨å…¥æ–¹å¼ï¼Œåªè¦æŠŠè¡¥ä¸soåº“çš„è·¯å¾„æ’å…¥åˆ°nativeLibraryDirectoriesæ•°ç»„çš„æœ€å‰é¢ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°åŠ è½½soåº“çš„æ—¶å€™æ˜¯è¡¥ä¸soåº“è€Œä¸æ˜¯åŸæ¥soåº“çš„ç›®å½•ï¼Œä»è€Œè¾¾åˆ°ä¿®å¤ã€‚</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"built_in\">String</span> <span class=\"function\"><span class=\"title\">findLibrary</span>(<span class=\"params\"><span class=\"built_in\">String</span> libraryName</span>)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">String</span> fileName = System.mapLibraryName(libraryName);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (NativeLibraryElement element : nativeLibraryPathElements) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">String</span> path = element.findNativeLibrary(fileName);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (path != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> path;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>ä¼˜ç‚¹ï¼šä¸éœ€ä¾µå…¥ç”¨æˆ·æ¥å£è°ƒç”¨<br>\nç¼ºç‚¹ï¼šéœ€è¦åšç‰ˆæœ¬å…¼å®¹æ§åˆ¶ï¼Œå…¼å®¹æ€§è¾ƒå·®</p>\n<h2 id=\"çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹\">çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹<a title=\"#çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹\" href=\"#çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹\"></a></h2>\n<p><img src=\"https://s1.ax1x.com/2022/03/06/bDwH8x.png\" alt=\"bDwH8x.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<h2 id=\"çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«\">çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«<a title=\"#çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«\" href=\"#çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«\"></a></h2>\n<blockquote>\n<p>æ’ä»¶åŒ–å’Œçƒ­ä¿®å¤çš„åŸç†ï¼Œéƒ½æ˜¯åŠ¨æ€åŠ è½½ dexï¼apk ä¸­çš„ç±»ï¼èµ„æºï¼Œè®©å®¿ä¸»æ­£å¸¸çš„åŠ è½½å’Œè¿è¡Œæ’ä»¶ï¼ˆè¡¥ä¸ï¼‰ä¸­çš„å†…å®¹</p>\n</blockquote>\n<ul>\n<li>\n<p>æ’ä»¶åŒ–ç›®æ ‡æ˜¯æƒ³æŠŠéœ€è¦å®ç°çš„æ¨¡å—æˆ–åŠŸèƒ½å½“åšä¸€ä¸ªç‹¬ç«‹çš„æå–å‡ºæ¥ï¼Œå‡å°‘å®¿ä¸»çš„è§„æ¨¡ã€‚é‡åœ¨è§£å†³ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠèµ„æºçš„é—®é¢˜</p>\n</li>\n<li>\n<p>çƒ­ä¿®å¤ç›®æ ‡åœ¨ä¿®å¤å·²æœ‰çš„é—®é¢˜ã€‚é‡åœ¨è§£å†³æ›¿æ¢å·²æœ‰çš„æœ‰é—®é¢˜çš„ç±»ï¼æ–¹æ³•ï¼èµ„æºç­‰</p>\n</li>\n</ul>\n<h2 id=\"deemo\">Deemo<a title=\"#deemo\" href=\"#deemo\"></a></h2>\n<p><a href=\"https://github.com/jiangzhengnan/Syringe\" target=\"_blank\">jiangzhengnan/Syringe: ğŸ“Œ æ’ä»¶åŒ–æ³¨å…¥å·¥ç¨‹(çƒ­ä¿®å¤+æ’ä»¶åŒ–)</a></p>\n<h2 id=\"refer\">Refer<a title=\"#refer\" href=\"#refer\"></a></h2>\n<p><a href=\"https://www.jianshu.com/p/cb1f0702d59f\" target=\"_blank\">çƒ­ä¿®å¤â€”â€”æ·±å…¥æµ…å‡ºåŸç†ä¸å®ç°</a><br>\n<a href=\"https://www.cnblogs.com/not2/p/11392733.html\" target=\"_blank\">çƒ­ä¿®å¤ - è¥¿è´é›ª</a><br>\n<a href=\"https://zhuanlan.zhihu.com/p/109169752\" target=\"_blank\">Androidçƒ­ä¿®å¤æŠ€æœ¯,ä½ ä¼šæ€ä¹ˆé€‰ï¼Ÿ</a><br>\n<a href=\"https://github.com/BigSweet/hotFixALL\" target=\"_blank\">BigSweet/hotFixALL: æ•´ç†andfix,thinker,robustçƒ­ä¿®å¤ä½¿ç”¨æ–¹æ³•å’ŒåŸç†</a><br>\n<a href=\"https://github.com/yoyiyi/SoleilNotes/blob/master/Android/%E7%83%AD%E4%BF%AE%E5%A4%8D.md\" target=\"_blank\">SoleilNotes/çƒ­ä¿®å¤.md at master Â· yoyiyi/SoleilNotes</a></p>\n","prev":{"title":"Androidé»‘ç§‘æŠ€ - æ’ä»¶åŒ–","link":"2022/03/07/yriIudTcpjYyMHli"},"next":{"title":"Androidé»‘ç§‘æŠ€ - çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŸºç¡€","link":"2022/03/07/ukYPIjylHjywfytF"},"plink":"http://onion66.gitee.io/blog/2022/03/07/phzbEh3JEzAC0XwD/","toc":[{"id":"å®ç°æ–¹æ¡ˆ","title":"å®ç°æ–¹æ¡ˆ","index":"1"},{"id":"çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹","title":"çƒ­ä¿®å¤æŠ€æœ¯æ–¹æ¡ˆé€‰å‹","index":"2"},{"id":"çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«","title":"çƒ­ä¿®å¤å’Œæ’ä»¶åŒ–åŒºåˆ«","index":"3"},{"id":"deemo","title":"Deemo","index":"4"},{"id":"refer","title":"Refer","index":"5"}],"reward":true,"copyright":{"custom":"Copyright:è‡ªç”±è½¬è½½-éå•†ç”¨-ç¦æ­¢æ¼”ç»-ä¿æŒç½²åï¼ˆCC BY-NC-ND 4.0ï¼‰"}}