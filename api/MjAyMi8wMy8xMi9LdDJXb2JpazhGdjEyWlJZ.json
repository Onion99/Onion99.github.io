{"title":"Android AOP - ASM+Transform","date":"2022-03-12T09:45:36.000Z","date_formatted":{"ll":"2022å¹´3æœˆ12æ—¥","L":"2022/03/12","MM-DD":"03-12"},"thumbnail":"https://s1.ax1x.com/2022/03/14/bLyIxO.md.png","link":"2022/03/12/Kt2Wobik8Fv12ZRY","comments":true,"tags":["AOP"],"categories":["Android"],"updated":"2022-03-12T01:50:00.000Z","content":"<span id=\"more\"></span>\n<p><img src=\"https://s1.ax1x.com/2022/03/10/bhoW8O.png\" alt=\"bhoW8O.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<h3 id=\"transform\">Transform<a title=\"#transform\" href=\"#transform\"></a></h3>\n<blockquote>\n<p>Android Gradle Plugin ä» 1.5.0 å¼€å§‹æ”¯æŒ Transform APIï¼Œä»¥å…è®¸ç¬¬ä¸‰æ–¹æ’ä»¶åœ¨ç»è¿‡ç¼–è¯‘çš„ .class æ–‡ä»¶è½¬æ¢ä¸º .dex æ–‡ä»¶ä¹‹å‰å¯¹å…¶è¿›è¡Œæ“çºµã€‚</p>\n</blockquote>\n<p>æ™®é€šç¼–è¯‘è¿‡ç¨‹ï¼š<br>\n<img src=\"https://s1.ax1x.com/2022/03/11/bINI8f.png\" alt=\"bINI8f.png\" loading=\"lazy\"><br>\nå¯ä»¥çœ‹åˆ°Android æ„å»ºæµç¨‹æ˜¯ä¸€å¥—æµæ°´çº¿çš„å·¥ä½œæœºåˆ¶ï¼Œæ¯ä¸€ä¸ªçš„æ„å»ºå•å…ƒæ¥æ”¶ä¸Šä¸€ä¸ªæ„å»ºå•å…ƒçš„è¾“å‡ºï¼Œä½œä¸ºè¾“å…¥ï¼Œå†å°†äº§å“è¿›è¡Œè¾“å‡ºï¼Œ<code>com.android.build</code>åº“æä¾›äº†<code>Transform</code>çš„æœºåˆ¶ï¼Œè€Œè¿™ä¸ªæœºåˆ¶æ˜¯Android æ„å»ºç³»ç»Ÿä¸ºäº†ç»™å¤–éƒ¨æä¾›ä¸€ä¸ªå¯ä»¥åŠ å…¥è‡ªå®šä¹‰æ„å»ºå•å…ƒï¼Œå¦‚æ‹¦æˆªæŸä¸ªæ„å»ºå•å…ƒçš„è¾“å‡ºï¼Œæˆ–è€…åŠ å…¥ä¸€äº›è¾“å‡ºç­‰ã€‚è€Œè¿™äº›Transformæ˜¯åœ¨javaæºç ç¼–è¯‘å®Œæˆä¹‹åï¼Œpackageä¹‹å‰è¿›è¡Œçš„ã€‚<br>\n<img src=\"https://s1.ax1x.com/2022/03/11/bIZBy8.md.png\" alt=\"bIZBy8.md.png\" loading=\"lazy\"></p>\n<p>åœ¨Android Gradleæ„å»ºç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡<code>AppExtension </code>å°†<code>transform</code>æ³¨å†Œåˆ°æ„å»ºç³»ç»Ÿä¸­:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title\">Plugin</span>&lt;<span class=\"title\">Project</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">apply</span><span class=\"params\">(Project project)</span> </span>&#123;</span><br><span class=\"line\">        AppExtension appExtension = (AppExtension)project.getProperties().get(<span class=\"string\">&quot;android&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// ç»™Appç¼–è¯‘è¿‡ç¨‹æ³¨å†Œtransform</span></span><br><span class=\"line\">        appExtension.registerTransform(<span class=\"keyword\">new</span> CustomTransform(), Collections.EMPTY_LIST);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"asm\">ASM<a title=\"#asm\" href=\"#asm\"></a></h3>\n<blockquote>\n<p><a href=\"https://asm.ow2.io/\" target=\"_blank\">ASM</a>æ˜¯ä¸€ç§é€šç”¨<strong>Javaå­—èŠ‚ç </strong>æ“ä½œå’Œåˆ†ææ¡†æ¶ã€‚å®ƒå¯ä»¥ç”¨æ¥ä¿®æ”¹ç°æœ‰çš„ç±»ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä»¥äºŒè¿›åˆ¶å½¢å¼åŠ¨æ€ç”Ÿæˆç±»ã€‚</p>\n</blockquote>\n<p><img src=\"https://s1.ax1x.com/2022/03/11/bI0iSx.png\" alt=\"bI0iSx.png\" loading=\"lazy\" class=\"Ï†bp\"></p>\n<p>ASMè®¾è®¡äº†ä¸¤ç§APIç±»å‹è§£ææ–‡ä»¶ç»“æ„ï¼š</p>\n<ul>\n<li>Tree API</li>\n<li>åŸºäºVisitor API(visitor pattern)ï¼Œ</li>\n</ul>\n<p>è®©æˆ‘ä»¬ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ä¸‹å§ğŸ¤¤ğŸ¤¤ğŸ¤¤</p>\n<h4 id=\"tree-api\">Tree API<a title=\"#tree-api\" href=\"#tree-api\"></a></h4>\n<p>Tree APIå°†classçš„ç»“æ„è¯»å–åˆ°å†…å­˜ï¼Œæ„å»ºä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œç„¶åéœ€è¦å¤„ç†Methodã€Fieldç­‰å…ƒç´ æ—¶ï¼Œåˆ°æ ‘å½¢ç»“æ„ä¸­å®šä½åˆ°æŸä¸ªå…ƒç´ ï¼Œè¿›è¡Œæ“ä½œï¼Œç„¶åæŠŠæ“ä½œå†å†™å…¥æ–°çš„classæ–‡ä»¶ã€‚</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestPlugin</span> : <span class=\"type\">Plugin</span>&lt;<span class=\"type\">Project</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">apply</span><span class=\"params\">(target: <span class=\"type\">Project</span>)</span></span> &#123;</span><br><span class=\"line\">        println(<span class=\"string\">&quot;Test Plugin : target = [<span class=\"subst\">$&#123;target&#125;</span>]&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">val</span> appExtension: AppExtension = target.extensions.getByType()</span><br><span class=\"line\">        appExtension.registerTransform(TestTransform())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestTransform</span> : <span class=\"type\">BaseTransform</span></span>()&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">companion</span> <span class=\"keyword\">object</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">var</span> isPrint = <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">var</span> isChange = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">modifyClass</span><span class=\"params\">(byteArray: <span class=\"type\">ByteArray</span>)</span></span>: ByteArray &#123;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> classReader = ClassReader(byteArray)</span><br><span class=\"line\">        <span class=\"keyword\">val</span> classNode = ClassNode()</span><br><span class=\"line\">        <span class=\"comment\">// é€šè¿‡ä¼ é€’ ClassReader è§£æå¯¹åº” ClassFile ç”Ÿæˆ ClassNode</span></span><br><span class=\"line\">        classReader.accept(classNode, ClassReader.EXPAND_FRAMES)</span><br><span class=\"line\">        <span class=\"comment\">// æ‰“å°æµ‹è¯•</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(isPrint)&#123;</span><br><span class=\"line\">            isPrint = <span class=\"literal\">false</span></span><br><span class=\"line\">            Log.log(classNode.toString())</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (methodNode <span class=\"keyword\">in</span> classNode.methods) &#123;</span><br><span class=\"line\">                Log.log(<span class=\"string\">&quot;<span class=\"subst\">$&#123;classNode.name&#125;</span> ------&gt;&gt;&gt; <span class=\"variable\">$methodNode</span>&quot;</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å¦‚æœæ–‡ä»¶å¯¹classNodeæœ‰ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è¿™æ ·å¤„ç†</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(isChange)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">val</span> classWriter = ClassWriter(ClassWriter.COMPUTE_MAXS)</span><br><span class=\"line\">            classNode.accept(classWriter)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> classWriter.toByteArray()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›ä¿®æ”¹å†…å®¹</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> byteArray</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">getInputTypes</span><span class=\"params\">()</span></span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> TransformManager.CONTENT_CLASS</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">getScopes</span><span class=\"params\">()</span></span>: MutableSet&lt;<span class=\"keyword\">in</span> QualifiedContent.Scope&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mutableSetOf(</span><br><span class=\"line\">            QualifiedContent.Scope.PROJECT</span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘çš„ç±»æ­£è¢«æˆ‘ä»¬æ‰“å°å‡ºæ¥ï¼š<br>\n<img src=\"https://s1.ax1x.com/2022/03/11/bIq3id.png\" alt=\"bIq3id.png\" loading=\"lazy\"></p>\n<h4 id=\"visitor-api\">Visitor API<a title=\"#visitor-api\" href=\"#visitor-api\"></a></h4>\n<p>Visitor APIåˆ™å°†é€šè¿‡æ¥å£çš„æ–¹å¼ï¼Œåˆ†ç¦»è¯»classå’Œå†™classçš„é€»è¾‘ï¼Œä¸€èˆ¬é€šè¿‡ä¸€ä¸ªClassReaderè´Ÿè´£è¯»å–classå­—èŠ‚ç ï¼Œç„¶åClassReaderé€šè¿‡ä¸€ä¸ªClassVisitoræ¥å£ï¼Œå°†å­—èŠ‚ç çš„æ¯ä¸ªç»†èŠ‚æŒ‰é¡ºåºé€šè¿‡æ¥å£çš„æ–¹å¼ï¼Œä¼ é€’ç»™ClassVisitorï¼ˆä½ ä¼šå‘ç°ClassVisitorä¸­æœ‰å¤šä¸ªvisitXXXXæ¥å£ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±åƒClassReaderå¸¦ç€ClassVisitoræ¸¸è§ˆäº†classå­—èŠ‚ç çš„æ¯ä¸€ä¸ªæŒ‡ä»¤ã€‚</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestPlugin</span> : <span class=\"type\">Plugin</span>&lt;<span class=\"type\">Project</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">apply</span><span class=\"params\">(target: <span class=\"type\">Project</span>)</span></span> &#123;</span><br><span class=\"line\">        println(<span class=\"string\">&quot;Test Plugin : target = [<span class=\"subst\">$&#123;target&#125;</span>]&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">val</span> appExtension: AppExtension = target.extensions.getByType()</span><br><span class=\"line\">        appExtension.registerTransform(TestVisitorTransform())</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestClassVisitor</span></span>(visitor: ClassVisitor):ClassVisitor(Opcodes.ASM4,visitor)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestVisitorTransform</span> : <span class=\"type\">BaseTransform</span></span>()&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">companion</span> <span class=\"keyword\">object</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">var</span> isPrint = <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">var</span> isChange = <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">modifyClass</span><span class=\"params\">(byteArray: <span class=\"type\">ByteArray</span>)</span></span>: ByteArray &#123;</span><br><span class=\"line\">        <span class=\"comment\">// è§£æclassæ–‡ä»¶</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> classReader = ClassReader(byteArray)</span><br><span class=\"line\">        <span class=\"comment\">// å°†classæ–‡ä»¶å†…å®¹å†™å…¥åˆ°ClassWriterä¸­</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> classWriter = ClassWriter(classReader,ClassWriter.COMPUTE_MAXS)</span><br><span class=\"line\">        <span class=\"comment\">// èµ‹äºˆå¯¹åº”çš„ClassVisitorè¯»å†™èƒ½åŠ›</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> classVisitor = TestClassVisitor(classWriter)</span><br><span class=\"line\">        classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES)</span><br><span class=\"line\">        <span class=\"comment\">// æ‰“å°æµ‹è¯•</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(isPrint)&#123;</span><br><span class=\"line\">            isPrint = <span class=\"literal\">false</span></span><br><span class=\"line\">            Log.log(classVisitor.toString())</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// å¦‚æœæ–‡ä»¶å¯¹classNodeæœ‰ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è¿™æ ·å¤„ç†</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(isChange)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> classWriter.toByteArray()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// è¿”å›ä¿®æ”¹å†…å®¹</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> byteArray</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">getInputTypes</span><span class=\"params\">()</span></span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> TransformManager.CONTENT_CLASS</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">getScopes</span><span class=\"params\">()</span></span>: MutableSet&lt;<span class=\"keyword\">in</span> QualifiedContent.Scope&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> mutableSetOf(</span><br><span class=\"line\">            QualifiedContent.Scope.PROJECT</span><br><span class=\"line\">        )</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åŒæ ·å¯ä»¥çœ‹åˆ°ç¼–è¯‘çš„ç±»æ­£è¢«æˆ‘ä»¬æ‰“å°å‡ºæ¥ï¼š<br>\n<img src=\"https://s1.ax1x.com/2022/03/11/bIvebV.png\" alt=\"bIvebV.png\" loading=\"lazy\"></p>\n<ul>\n<li>ClassReaderï¼šè´Ÿè´£å¯¹ .class æ–‡ä»¶è¿›è¡Œè¯»å–</li>\n<li>ClassVisitorï¼š è´Ÿè´£è®¿é—® .class æ–‡ä»¶ä¸­å„ä¸ªå…ƒç´ </li>\n<li>ClassWriterï¼š è´Ÿè´£å¯¹ .class æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œå°†å­—èŠ‚ç è¾“å‡ºä¸º byte æ•°ç»„ã€‚</li>\n</ul>\n<h3 id=\"å­—èŠ‚ç äº†è§£\">å­—èŠ‚ç äº†è§£<a title=\"#å­—èŠ‚ç äº†è§£\" href=\"#å­—èŠ‚ç äº†è§£\"></a></h3>\n<p><a href=\"https://plugins.jetbrains.com/plugin/14860-asm-bytecode-viewer-support-kotlin\" target=\"_blank\">Android Studio è¾…åŠ©ç±»è½¬å­—èŠ‚ç æ’ä»¶ï¼šASM Bytecode Viewer Support Kotlin</a><br>\n<img src=\"https://pic1.zhimg.com/v2-fdd5caeb51dbfb819539611fa9ccbcd4_r.jpg\" alt=\"preview\" loading=\"lazy\"></p>\n<p><a href=\"https://juejin.cn/post/6944517233674551304#heading-5\" target=\"_blank\">å­—èŠ‚ç ç»“æ„åˆ†æ - æ˜é‡‘ (juejin.cn)</a><br>\n<a href=\"https://www.jianshu.com/p/92a75a18cbc1\" target=\"_blank\">Java ByteCode - ç®€ä¹¦ (jianshu.com)</a><br>\n<a href=\"https://zhuanlan.zhihu.com/p/94498015\" target=\"_blank\">å²ä¸Šæœ€é€šä¿—æ˜“æ‡‚çš„ASMæ•™ç¨‹ - çŸ¥ä¹ (zhihu.com)</a></p>\n<h3 id=\"è‡ªå®šä¹‰gradleæ’ä»¶\">è‡ªå®šä¹‰gradleæ’ä»¶<a title=\"#è‡ªå®šä¹‰gradleæ’ä»¶\" href=\"#è‡ªå®šä¹‰gradleæ’ä»¶\"></a></h3>\n<blockquote>\n<p>Transformå’ŒAsmçš„ç»“åˆä½¿ç”¨éœ€è¦ç”¨åˆ°Gradleæ’ä»¶</p>\n</blockquote>\n<p>è‡ªå®šä¹‰æ’ä»¶æ–¹å¼ï¼šè¯¦çœ‹<a href=\"https://docs.gradle.org/current/userguide/custom_plugins.html#example_a_build_for_a_custom_plugin\" target=\"_blank\">Developing Custom Gradle Plugins</a></p>\n<ul>\n<li>Build script</li>\n<li><code>buildSrc</code> é¡¹ç›®</li>\n<li>ç‹¬ç«‹é¡¹ç›®ï¼ˆStandalone projectï¼‰</li>\n</ul>\n<h4 id=\"build-script\">Build script<a title=\"#build-script\" href=\"#build-script\"></a></h4>\n<blockquote>\n<p>ç›´æ¥åœ¨é¡¹ç›®çš„build.gradleä¸­æ·»åŠ groovyè„šæœ¬ä»£ç å¹¶å¼•ç”¨ã€‚è¿™æ ·æ’ä»¶åœ¨æ„å»ºè„šæœ¬ä¹‹å¤–ä¸å¯è§ï¼Œåªèƒ½åœ¨æ­¤æ¨¡å—ä¸­ä½¿ç”¨è„šæœ¬æ’ä»¶ã€‚</p>\n</blockquote>\n<ol>\n<li>ç®€å•ç¼–å†™è„šæœ¬<br>\nbuild.gradle:</li>\n</ol>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GreetingPlugin</span> <span class=\"keyword\">implements</span> <span class=\"title\">Plugin</span>&lt;<span class=\"title\">Project</span>&gt; &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> apply(Project project) &#123;</span><br><span class=\"line\">        project.task(<span class=\"string\">&#x27;hello&#x27;</span>) &#123;</span><br><span class=\"line\">            doLast &#123;</span><br><span class=\"line\">                println <span class=\"string\">&#x27;Hello from the GreetingPlugin&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Apply the plugin</span></span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> GreetingPlugin</span><br></pre></td></tr></table></figure>\n<p>è·Ÿä¸Šé¢ä¸€æ ·ï¼Œåªä¸è¿‡é‡‡ç”¨æ–°ç‰ˆktsé£æ ¼<br>\nbuild.gradle.kts</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GreetingPlugin</span> : <span class=\"type\">Plugin</span>&lt;<span class=\"type\">Project</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">apply</span><span class=\"params\">(project: <span class=\"type\">Project</span>)</span></span> &#123;</span><br><span class=\"line\">        project.task(<span class=\"string\">&quot;hello&quot;</span>) &#123;</span><br><span class=\"line\">            doLast &#123;</span><br><span class=\"line\">                println(<span class=\"string\">&quot;Hello from the GreetingPlugin&quot;</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Apply the plugin</span></span><br><span class=\"line\">apply&lt;GreetingPlugin&gt;()</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>è¿è¡Œ</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; gradle -q hello</span><br><span class=\"line\">Hello from the GreetingPlugin</span><br></pre></td></tr></table></figure>\n<h4 id=\"buildsrc-é¡¹ç›®\">buildSrc é¡¹ç›®<a title=\"#buildsrc-é¡¹ç›®\" href=\"#buildsrc-é¡¹ç›®\"></a></h4>\n<blockquote>\n<p>å°†æ’ä»¶çš„æºä»£ç æ”¾åœ¨rootProjectDir/buildSrc/src/main/groovyç›®å½•ä¸­ï¼ŒGradleå°†è´Ÿè´£ç¼–è¯‘å’Œæµ‹è¯•æ’ä»¶ï¼Œå¹¶ä½¿å…¶åœ¨æ„å»ºè„šæœ¬çš„ç±»è·¯å¾„ä¸­å¯ç”¨ã€‚è¯¥æ’ä»¶æ¯ä¸ªæ„å»ºè„šæœ¬éƒ½æ˜¯å¯è§çš„ã€‚ä½†æ˜¯å®ƒåœ¨æ„å»ºå¤–éƒ¨ä¸å¯è§å³åœ¨å½“å‰å·¥ç¨‹çš„å„ä¸ªæ¨¡å—éƒ½å¯è§ï¼Œä½†æ˜¯é¡¹ç›®ä¹‹å¤–ä¸å¯è§</p>\n</blockquote>\n<p>buildSrcæ˜¯androidä¸­ä¸€ä¸ªä¿ç•™åï¼Œæ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥åšgradleæ’ä»¶çš„moduleï¼Œæ‰€ä»¥è¿™ä¸ªmoduleçš„åå­—å¿…é¡»æ˜¯buildSrcï¼Œæ­¤æ¨¡å—ä¸‹é¢æœ‰ä¸€ä¸ªå›ºå®šçš„ç›®å½•ç»“æ„src/main/groovyï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥å­˜æ”¾çœŸæ­£çš„è„šæœ¬æ–‡ä»¶çš„ã€‚å…¶ä»–çš„è‡ªå®šä¹‰ç±»å¯ä»¥æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨è‡ªå»ºçš„å…¶ä»–ç›®å½•ä¸‹ã€‚</p>\n<ol>\n<li>åˆ›å»º<code>buildSrc</code>Module,å¯ä»¥ç›´æ¥åˆ›å»ºç›®å½•\n<ul>\n<li>åœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹åˆ›å»ºç›®å½•<code>buildSrc</code></li>\n<li>åœ¨buildSrcä¸‹åˆ›å»ºç›®å½•ç»“æ„ <code>src/main/groovy</code>æˆ–è€…<code>src/main/java</code></li>\n<li>åœ¨buildSrcæ ¹ç›®å½•ä¸‹åˆ›å»º<code> build.gradle</code>æˆ–è€…<code> build.gradle.kts</code></li>\n</ul>\n</li>\n</ol>\n<p>build.gradle.kts:</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.jetbrains.kotlin.gradle.tasks.KotlinCompile</span><br><span class=\"line\"></span><br><span class=\"line\">plugins &#123;</span><br><span class=\"line\">    `kotlin-dsl`</span><br><span class=\"line\">    kotlin(<span class=\"string\">&quot;jvm&quot;</span>) version <span class=\"string\">&quot;1.4.32&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">val</span> compileKotlin: KotlinCompile <span class=\"keyword\">by</span> tasks</span><br><span class=\"line\"><span class=\"keyword\">val</span> compileTestKotlin: KotlinCompile <span class=\"keyword\">by</span> tasks</span><br><span class=\"line\">compileKotlin.kotlinOptions &#123;</span><br><span class=\"line\">    jvmTarget = <span class=\"string\">&quot;1.8&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">compileTestKotlin.kotlinOptions &#123;</span><br><span class=\"line\">    jvmTarget = <span class=\"string\">&quot;1.8&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">repositories &#123;</span><br><span class=\"line\">    google()</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    implementation(<span class=\"string\">&quot;com.android.tools.build:gradle:4.1.1&quot;</span>)</span><br><span class=\"line\">    compileOnly(<span class=\"string\">&quot;commons-io:commons-io:2.6&quot;</span>)</span><br><span class=\"line\">    compileOnly(<span class=\"string\">&quot;commons-codec:commons-codec:1.15&quot;</span>)</span><br><span class=\"line\">    compileOnly(<span class=\"string\">&quot;org.ow2.asm:asm-commons:9.2&quot;</span>)</span><br><span class=\"line\">    compileOnly(<span class=\"string\">&quot;org.ow2.asm:asm-tree:9.2&quot;</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>build.gradle</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply <span class=\"attr\">plugin:</span> <span class=\"string\">&#x27;groovy&#x27;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">dependencies &#123;</span><br><span class=\"line\">    <span class=\"comment\">// gradleæ’ä»¶å¿…é¡»çš„å¼•ç”¨</span></span><br><span class=\"line\">    implementation gradleApi()</span><br><span class=\"line\">    implementation localGroovy()</span><br><span class=\"line\">    </span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;com.android.tools.build:gradle:4.1.1&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">// asmä¾èµ–</span></span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;org.ow2.asm:asm:9.2&#x27;</span></span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;org.ow2.asm:asm-util:9.2&#x27;</span></span><br><span class=\"line\">    implementation <span class=\"string\">&#x27;org.ow2.asm:asm-commons:9.2&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">repositories &#123;</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">    jcenter()</span><br><span class=\"line\">    google()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">// æŒ‡å®šç¼–è¯‘çš„ç¼–ç  ä¸ç„¶æœ‰ä¸­æ–‡çš„è¯ä¼šå‡ºç°  â€™ç¼–ç GBKçš„ä¸å¯æ˜ å°„å­—ç¬¦â€˜</span></span><br><span class=\"line\">tasks.withType(JavaCompile) &#123;</span><br><span class=\"line\">    options.encoding = <span class=\"string\">&quot;UTF-8&quot;</span></span><br><span class=\"line\">    println(<span class=\"string\">&#x27;ä½¿ç”¨utf8ç¼–è¯‘&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>åˆ›å»ºæ’ä»¶å…¥å£TestPlugin</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.onion.plugin.plugin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestPlugin</span>: <span class=\"type\">Plugin</span>&lt;<span class=\"type\">Project</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">apply</span><span class=\"params\">(target: <span class=\"type\">Project</span>)</span></span> &#123;</span><br><span class=\"line\">        println(<span class=\"string\">&quot;Test Plugin : target = [<span class=\"subst\">$&#123;target&#125;</span>]&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>åœ¨App Module ä¸­å¼•å…¥,ç„¶åProject Build</li>\n</ol>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.onion.plugin.plugin.TestPlugin</span><br><span class=\"line\">apply <span class=\"attr\">plugin:</span> TestPlugin <span class=\"comment\">// æ’æ¡©æµ‹è¯•</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"æ’ä»¶å‘å¸ƒé¢å¤–å­¦ä¹ \">æ’ä»¶å‘å¸ƒé¢å¤–å­¦ä¹ <a title=\"#æ’ä»¶å‘å¸ƒé¢å¤–å­¦ä¹ \" href=\"#æ’ä»¶å‘å¸ƒé¢å¤–å­¦ä¹ \"></a></h4>\n<ul>\n<li><a href=\"https://juejin.cn/post/6887581345384497165\" title=\"https://juejin.cn/post/6887581345384497165\" target=\"_blank\">Android Gradle æ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—ï¼ˆä¸€ï¼‰</a>ï¼Œè®²è§£Gradle Pluginå¼€å‘çš„å®Œæ•´æµç¨‹</li>\n<li><a href=\"https://juejin.cn/post/6887583351348133895\" title=\"https://juejin.cn/post/6887583351348133895\" target=\"_blank\">Android Gradle æ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—ï¼ˆäºŒï¼‰</a>ï¼Œé’ˆå¯¹Androidçš„Gradle Pluginå¼€å‘å®è·µ</li>\n<li><a href=\"https://juejin.cn/post/6890544619856068616\" title=\"https://juejin.cn/post/6890544619856068616\" target=\"_blank\">Android Gradle æ’ä»¶å¼€å‘å…¥é—¨æŒ‡å—ï¼ˆä¸‰ï¼‰</a>ï¼Œå¦‚ä½•å°†æ’ä»¶å‘å¸ƒåˆ°jcenter</li>\n</ul>\n<h3 id=\"refer\">Refer<a title=\"#refer\" href=\"#refer\"></a></h3>\n<p><a href=\"http://quinnchen.cn/2018/09/13/2018-09-13-asm-transform/\" target=\"_blank\">ä¸€èµ·ç©è½¬Androidé¡¹ç›®ä¸­çš„å­—èŠ‚ç  | Quinn Note (quinnchen.cn)</a><br>\n<a href=\"https://www.jianshu.com/p/92a75a18cbc1\" target=\"_blank\">Java ByteCode</a><br>\n<a href=\"https://blog.csdn.net/qq_23992393/article/details/103696976\" target=\"_blank\">ASM + Transform åœ¨androidä¸­çš„ä½¿ç”¨</a><br>\n<a href=\"https://www.jianshu.com/p/a1e6b3abd789\" target=\"_blank\">ASM</a><br>\n<a href=\"https://juejin.cn/post/6893917892061413389#heading-3\" target=\"_blank\">ç™½è¯ Android AOP (ä¸€) </a><br>\n<a href=\"https://mp.weixin.qq.com/s/YFi6-DrV22X_VVfFbKHNEg\" target=\"_blank\">Android gradle Transform åˆ†æ</a></p>\n","prev":{"title":"Android - å¤šæ¸ é“æ‰“åŒ…","link":"2022/03/13/XJTlmsU39F0XEnje"},"next":{"title":"Android AOP - AspectJ","link":"2022/03/11/3Bhw0wOwpYCE6F8V"},"plink":"https://onion99.github.io/2022/03/12/Kt2Wobik8Fv12ZRY/","reward":true,"copyright":{"custom":"Copyright:è‡ªç”±è½¬è½½-éå•†ç”¨-ç¦æ­¢æ¼”ç»-ä¿æŒç½²åï¼ˆCC BY-NC-ND 4.0ï¼‰"}}